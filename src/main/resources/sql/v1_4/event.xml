<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hongzhi.zswh.app_1_4.dao.EventDao">



    <select id="statusInfo" resultType="map" >
    select
         case when user_id = #{userID}
              then 'true'
              else 'false'
              end as is_registered
        ,count(1) as registered_count
    from event_registration
    where event_id = #{eventID}
    </select>

    <insert id="createEvent"  useGeneratedKeys="true"  keyProperty="event_id" >
    insert into event (
          event_name
         ,club_id
         ,start_time
         ,end_time
         ,register_start_time
         ,register_end_time
         ,organizer_id
         ,event_address
         ,min_people
         ,max_people
         ,fee
         ,image
         ,event_status
         ,view_guests
         ,form_item
    ) values (
          #{event_name}
         ,#{club_id}
         ,#{sql_start_time}
         ,#{sql_end_time}
         ,#{sql_register_start_time}
         ,#{sql_register_end_time}
         ,#{organizer_id}
         ,#{event_address}
         ,#{min_people}
         ,#{max_people}
         ,#{fee}
         ,#{image}
         ,#{event_status}
         ,#{view_guests}
         ,#{form_item}
    )

    </insert>

    <select id="eventIDs" resultType="Integer" >
    select
        event_id
    from event
    where club_id = #{club_id}
    </select>

    <update id="passReview" >
    update event
      set  event_status = #{status}
    where event_id = #{eventID}
    </update>

    <select id="events" resultType="com.hongzhi.zswh.app_1_4.entity.Event">
        select
             a.event_id
            ,a.club_id
            ,a.end_time
            ,a.event_address
            ,a.event_name
            ,a.event_status
            ,coalesce(a.fee,0.0)  as fee
            ,a.form_item
            ,concat('/pic.htmls?p=',coalesce(a.image,'')) as image
            ,coalesce(a.max_people,0) as max_people
            ,coalesce(a.min_people,0) as min_people
            ,a.organizer_id
            ,a.register_end_time
            ,a.register_start_time
            ,a.start_time
            ,a.view_guests
        from
            event a
        where
        <if test=" event_id !=null  and   event_id !='' ">
            a.event_id = #{event_id}
        and
        </if>
        <if test="club_id !=null  and   club_id !='' ">
            a.club_id = #{club_id}
        and
        </if>
            a.event_status = 1
        or
          (a.event_status = 2 and a.end_time > now())

    </select>
    <select id="latestEventList" resultType="com.hongzhi.zswh.app_1_4.entity.Event">
          select
             d.event_id
            ,d.club_id
            ,d.end_time
            ,d.event_address
            ,d.event_name
            ,d.event_status
            ,coalesce(d.fee,0.0)  as fee
            ,d.form_item
            ,concat('/pic.htmls?p=',coalesce(d.image,'')) as image
            ,coalesce(d.max_people,0) as max_people
            ,coalesce(d.min_people,0) as min_people
            ,d.organizer_id
            ,d.register_end_time
            ,d.register_start_time
            ,d.start_time
            ,d.view_guests
          from
             (
             select
                  COUNT(1) as sum_member
                  ,a.event_id as event_id
              from
                  event a
              left join
                  event_registration b
              on
                  a.event_id = b.event_id
        where
            a.event_status = 1
        and
        <![CDATA[
        a.register_start_time < now()
        ]]>
        and
        <![CDATA[
        a.register_end_time > NOW()
        ]]>
        GROUP BY a.event_id
        ) c
        LEFT JOIN
            event d
        on
            d.event_id = c.event_id
        where
         <![CDATA[
            c.sum_member < d.max_people
        ]]>
        or
            coalesce(d.max_people,0) = 0
         <if  test="club_id !=0 ">
             and d.club_id = #{club_id}
         </if>

        ORDER BY d.start_time desc
        LIMIT 2
    </select>


    <insert id="saveEventItems">
    insert into event_form (
         event_id
        ,item_code
    ) values
    <foreach collection="items" item="item" separator="," >
        (
          #{eventID}
         ,#{item}
        )
    </foreach>
    </insert>

    <select id="formItems" resultType="map" >
    select
         a.event_id
        ,a.club_id
        ,b.item_code
        ,c.item_name
        ,coalesce(d.item_value,'')  as item_value
    from event a
    left join event_form b
           on a.event_id = b.event_id
    left join event_form_item c
           on b.item_code = c.item_code
    left join user_profile d
           on b.item_code = d.item_code
          and d.user_id = #{userID}
    where a.event_id = #{eventID}
    order by c.index
    </select>

    <insert id="saveUserRegister" >
    insert into  event_registration (
      event_id
     ,user_id
     ,create_time
     ,my_status
    ) values (
      #{eventID}
     ,#{userID}
     ,now()
     ,1
    )
    </insert>

    <update id="unregister" >
     update  event_registration
        set my_status = 0
      where event_id = #{eventID}
        and user_id = #{userID}
    </update>


    <select id="myJoinEvent" resultType="com.hongzhi.zswh.app_1_4.entity.Event">
          select
             b.event_id
            ,b.club_id
            ,b.end_time
            ,b.event_address
            ,b.event_name
            ,b.event_status
            ,coalesce(b.fee,0.0)  as fee
            ,b.form_item
            ,concat('/pic.htmls?p=',coalesce(b.image,'')) as image
            ,coalesce(b.max_people,0) as max_people
            ,coalesce(b.min_people,0) as min_people
            ,b.organizer_id
            ,b.register_end_time
            ,b.register_start_time
            ,b.start_time
            ,b.view_guests
          from
              event_registration a
          LEFT JOIN
              event b
          on
              a.event_id = b.event_id
          where
              a.user_id =#{user_id}
          and
              a.my_status = 1
          and
              b.club_id = #{club_id}
    </select>
    <select id="mySetEvent" resultType="com.hongzhi.zswh.app_1_4.entity.Event">
          select
             a.event_id
            ,a.club_id
            ,a.end_time
            ,a.event_address
            ,a.event_name
            ,a.event_status
            ,coalesce(a.fee,0.0)  as fee
            ,a.form_item
            ,concat('/pic.htmls?p=',coalesce(a.image,'')) as image
            ,coalesce(a.max_people,0) as max_people
            ,coalesce(a.min_people,0) as min_people
            ,a.organizer_id
            ,a.register_end_time
            ,a.register_start_time
            ,a.start_time
            ,a.view_guests
          from
              event a
          where
              a.club_id = #{club_id}
          and
              a.organizer_id = #{user_id}
    </select>
    <select id="verifyEvent" resultType="com.hongzhi.zswh.app_1_4.entity.Event">
          select
                 a.event_id
                ,a.club_id
                ,a.end_time
                ,a.event_address
                ,a.event_name
                ,a.event_status
                ,coalesce(a.fee,0.0)  as fee
                ,a.form_item
                ,concat('/pic.htmls?p=',coalesce(a.image,'')) as image
                ,coalesce(a.max_people,0) as max_people
                ,coalesce(a.min_people,0) as min_people
                ,a.organizer_id
                ,a.register_end_time
                ,a.register_start_time
                ,a.start_time
                ,a.view_guests
          from
              event a
          where
              a.event_status = 0
          and
              a.club_id = #{club_id}
    </select>


    <insert id="saveUserProfile" >
    insert into user_profile
        (
        user_id
       ,item_code
       ,item_value
       ) values
       <foreach collection="profiles" item="profile" separator="," >
       (
        #{userID}
       ,#{profile.item_code}
       ,#{profile.item_value}
       )
       </foreach>
    </insert>

    <select id="selectMyEvent" resultType="Integer">
          select
              COUNT(1) my_counts
          from
              event_registration a
          where
              a.user_id = #{user_id}
          and
              a.my_status = 1

    </select>
</mapper>